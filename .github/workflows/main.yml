name: Deploy Google Cloud Function

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify gcloud
        run: gcloud info

      - name: Deploy (Gen2)
        run: |
          gcloud functions deploy hellohttp-roger \
            --gen2
            --runtime nodejs20 \
            --region "${{ secrets.GCP_REGION }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --trigger-http \
            --allow-unauthenticated \
            --entry-point helloHttp \
            --source .

      # For Cloud Functions Gen2 (optional). Remove Gen1 step above and uncomment below if you migrate.
      # - name: Deploy (Gen2)
      #   run: |
      #     gcloud functions deploy helloHttp \
      #       --gen2 \
      #       --runtime nodejs20 \
      #       --region "${{ secrets.GCP_REGION }}" \
      #       --project "${{ secrets.GCP_PROJECT_ID }}" \
      #       --trigger-http \
      #       --allow-unauthenticated \
      #       --entry-point helloHttp \
      #       --source .
